<html>
<head><meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.0-rc.2/angular.js"></script>
<script src="http://code.jquery.com/jquery-2.0.3.js"></script>
<script src="https://code.angularjs.org/1.2.0-rc.2/angular-route.js"></script>
<script src='https://cdn.firebase.com/js/client/2.1.1/firebase.js'></script>
<script src="https://cdn.firebase.com/libs/angularfire/0.6.0/angularfire.min.js"></script>
<script src="js/linq.js"></script>


</head>

<script>

var app = angular.module("myApp", ["ngRoute", "firebase"]);
app.run(function() {
})

app.config(function($routeProvider) {
    $routeProvider
    .when("/", {
        templateUrl : "main.htm"
    })
    .when("/edittodo/:uniquekey", {
        templateUrl : "edittodo.htm",
        controller : "editTODOCtrl"
    })
    .when("/newtodo", {
        templateUrl : "newtodo.htm",
        controller : "newTODOCtrl"
    })
});
app.controller("newTODOCtrl", function($scope) {
    $scope.steps = [];
    $scope.addStep = function () {
        $scope.steps.push($scope.newStep);
        $scope.newStep = "";
    }
    $scope.removeStep = function (x) {
        $scope.steps.splice(x, 1);
    }
});
app.constant({fireBaseUrl: 'https://demotodolist-ff08f.firebaseio.com/'});
app.controller('editTODOCtrl',function($scope,$routeParams){
    $scope.todolistkey= $routeParams.uniquekey;//'emp_0'+ (parseInt($routeParams.uniquekey)+1);

});

app.controller('showTODOLists', function($scope , $timeout, $routeParams,  fireBaseUrl,  $firebase ) {
        Enumerable.Utils.extendTo(Array);
        var emptyTODOList = {key:'',todolist:[{act:'',step:''}]};

        $scope.items = [];
        $scope.isUpdate = false;
        $scope.newTODO = emptyTODOList;
        var param = $routeParams.uniquekey;
        console.log(param);

        /*var select = param?'records/'+param+'/todolist':'records';
        var datas = $firebase(new Firebase(fireBaseUrl+select));
        $scope.groups = datas;*/

        var ref = new Firebase(fireBaseUrl);
        if (param){
        	//$scope.groups = $firebase(
        		ref.child('records').orderByChild('key').equalTo(param).once('value', function(snapshot){
					$timeout(function() {
						console.log(snapshot.val());
						$scope.groups = snapshot.val()[0].todolist;
						
						console.log($scope.groups);
						return snapshot.val()[0].todolist
					});			            
			     });
        	
        }
        else {
        	datas = $firebase(ref.child('records'));

        	$scope.groups = datas;
        	console.log($scope.groups);
        }
        

        $scope.removeTODOAct = function(id) {
                    $scope.groups.$remove(id);
                }; 

        $scope.addTODOAct = function(step, act){
        			var item = {"step":step,"act":act};
        			$scope.groups.$add(item).then(function(p){
		        		console.log(act);
		        	});	        
                };

        $scope.addTODOList = function(key){
        			var item = {"key":key,"todolist":[]};
        			$scope.groups.$add(item).then(function(p){
		        		console.log(act);
		        	});	        
                };       

    });

</script>

<body>
<div ng-app="myApp">
	<p><a href="#/">Main</a></p>

	<p><a href="#newtodo">Create new TODO list</a></p>

	<a href="#edittodo/123">Red</a>

	<div ng-view></div>

</div>
</body>

</html>